---
- name: Manage CloudFront distribution
  when: cloudfront_enabled
  block:
    - name: Ensure CloudFront distribution is present
      when: (cloudfront_state | default('present')) == 'present'
      block:
        - name: Lookup CloudFront distribution id by primary alias
          ansible.builtin.command:
            argv:
              - aws
              - cloudfront
              - list-distributions
              - --query
              - >-
                DistributionList.Items[?Aliases.Quantity > `0` && contains(Aliases.Items, '{{ cloudfront_aliases | first }}')].Id | [0]
              - --output
              - text
          register: cloudfront_alias_lookup
          changed_when: false
          when:
            - (cloudfront_distribution_id | default('')) == ''
            - cloudfront_aliases is defined
            - cloudfront_aliases | length > 0

        - name: Store CloudFront distribution id from alias lookup
          ansible.builtin.set_fact:
            cloudfront_distribution_id: "{{ cloudfront_alias_lookup.stdout }}"
          when:
            - (cloudfront_distribution_id | default('')) == ''
            - cloudfront_alias_lookup.stdout is defined
            - cloudfront_alias_lookup.stdout != "None"

        - name: Select CloudFront aliases and certificate
          ansible.builtin.set_fact:
            cloudfront_effective_aliases: "{{ cloudfront_aliases if cloudfront_use_custom_certificate else [] }}"
            cloudfront_effective_viewer_certificate: >-
              {{
                cloudfront_viewer_certificate | combine({ 'cloudfront_default_certificate': false })
                if cloudfront_use_custom_certificate
                else { 'cloudfront_default_certificate': true }
              }}
          vars:
            cloudfront_use_custom_certificate: >-
              {{
                (acm_certificate_ready | default(true))
                if (acm_enabled | default(false))
                else true
              }}

        - name: Ensure CloudFront distribution is present
          community.aws.cloudfront_distribution:
            state: present
            caller_reference: "{{ cloudfront_caller_reference if (cloudfront_distribution_id | default('')) == '' else omit }}"
            distribution_id: "{{ cloudfront_distribution_id | default(omit) }}"
            comment: "{{ cloudfront_comment }}"
            enabled: true
            default_root_object: "{{ cloudfront_default_root_object }}"
            price_class: "{{ cloudfront_price_class }}"
            aliases: "{{ cloudfront_effective_aliases }}"
            origins: "{{ cloudfront_origins }}"
            default_cache_behavior: "{{ cloudfront_default_cache_behavior }}"
            viewer_certificate: "{{ cloudfront_effective_viewer_certificate }}"
            tags: "{{ common_tags }}"
          register: cloudfront_result

        - name: Store CloudFront domain name
          ansible.builtin.set_fact:
            cloudfront_domain_name: "{{ cloudfront_result.domain_name }}"
          when: cloudfront_result.domain_name is defined

        - name: Store CloudFront distribution id
          ansible.builtin.set_fact:
            cloudfront_distribution_id: "{{ cloudfront_result.id }}"
          when: cloudfront_result.id is defined

        - name: Extract CloudFront origin access identity
          ansible.builtin.set_fact:
            cloudfront_oai_path: >-
              {{
                (cloudfront_result.origins['items'] | default([]) | first | default({}))
                  .get('s3_origin_config', {})
                  .get('origin_access_identity', '')
              }}
          when:
            - s3_enabled
            - (s3_state | default('present')) == 'present'

        - name: Build CloudFront origin access identity ARN
          ansible.builtin.set_fact:
            cloudfront_oai_id: "{{ cloudfront_oai_path.split('/')[-1] }}"
            cloudfront_oai_arn: "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity {{ cloudfront_oai_path.split('/')[-1] }}"
          when:
            - s3_enabled
            - (s3_state | default('present')) == 'present'

        - name: Ensure CloudFront origin access identity is configured
          ansible.builtin.assert:
            that:
              - cloudfront_oai_path != ""
            fail_msg: "CloudFront origin access identity not found; set s3_origin_access_identity_enabled: true for the S3 origin."
          when:
            - s3_enabled
            - (s3_state | default('present')) == 'present'

        - name: Build S3 bucket policy for CloudFront
          ansible.builtin.set_fact:
            s3_cloudfront_policy: "{{ s3_cloudfront_policy_doc | to_json }}"
          vars:
            s3_cloudfront_policy_doc:
              Version: "2012-10-17"
              Statement:
                - Sid: "AllowCloudFrontOriginAccessIdentityReadOnly"
                  Effect: "Allow"
                  Principal:
                    AWS: "{{ cloudfront_oai_arn }}"
                  Action:
                    - "s3:GetObject"
                  Resource: "arn:aws:s3:::{{ s3_bucket_name }}/*"
          when:
            - s3_enabled
            - (s3_state | default('present')) == 'present'

        - name: Apply S3 bucket policy for CloudFront
          amazon.aws.s3_bucket:
            name: "{{ s3_bucket_name }}"
            state: present
            region: "{{ aws_region }}"
            policy: "{{ s3_cloudfront_policy }}"
          register: s3_policy_result
          retries: "{{ s3_policy_retries | default(18) }}"
          delay: "{{ s3_policy_delay | default(10) }}"
          until: s3_policy_result is succeeded
          when:
            - s3_enabled
            - (s3_state | default('present')) == 'present'

    - name: Disable CloudFront distribution
      when: (cloudfront_state | default('present')) == 'absent'
      block:
        - name: Lookup CloudFront distribution id for disable
          ansible.builtin.command:
            argv:
              - aws
              - cloudfront
              - list-distributions
              - --query
              - "DistributionList.Items[?Comment=='{{ cloudfront_comment }}'].Id | [0]"
              - --output
              - text
          register: cloudfront_id_lookup
          changed_when: false
          when:
            - (cloudfront_distribution_id | default('')) == ''

        - name: Store CloudFront distribution id for disable
          ansible.builtin.set_fact:
            cloudfront_distribution_id: "{{ cloudfront_id_lookup.stdout }}"
          when:
            - (cloudfront_distribution_id | default('')) == ''
            - cloudfront_id_lookup.stdout is defined
            - cloudfront_id_lookup.stdout != "None"

        - name: Fetch CloudFront distribution config for disable
          ansible.builtin.command:
            argv:
              - aws
              - cloudfront
              - get-distribution-config
              - --id
              - "{{ cloudfront_distribution_id }}"
              - --output
              - json
          register: cloudfront_disable_config_raw
          changed_when: false
          when:
            - cloudfront_distribution_id is defined
            - cloudfront_distribution_id | length > 0

        - name: Build CloudFront disable config
          ansible.builtin.set_fact:
            cloudfront_disable_etag: "{{ (cloudfront_disable_config_raw.stdout | from_json).ETag }}"
            cloudfront_disable_config: >-
              {{
                (cloudfront_disable_config_raw.stdout | from_json).DistributionConfig
                | combine(
                  {
                    'Enabled': false,
                    'Aliases': {'Quantity': 0},
                    'ViewerCertificate': {
                      'CloudFrontDefaultCertificate': true,
                      'MinimumProtocolVersion': cloudfront_disable_minimum_protocol
                    }
                  },
                  recursive=false
                )
              }}
          vars:
            cloudfront_disable_minimum_protocol: >-
              {{
                (cloudfront_viewer_certificate.minimum_protocol_version
                if (cloudfront_viewer_certificate | default({})).minimum_protocol_version is defined
                else 'TLSv1.2_2021')
              }}
          when:
            - cloudfront_disable_config_raw.stdout is defined
            - cloudfront_disable_config_raw.stdout | length > 0

        - name: Create temp file for CloudFront disable config
          ansible.builtin.tempfile:
            state: file
            suffix: cloudfront-disable.json
          register: cloudfront_disable_tmp
          when:
            - cloudfront_disable_config is defined

        - name: Write CloudFront disable config
          ansible.builtin.copy:
            dest: "{{ cloudfront_disable_tmp.path }}"
            content: "{{ cloudfront_disable_config | to_json }}"
          when:
            - cloudfront_disable_tmp.path is defined

        - name: Disable CloudFront distribution (no wait)
          ansible.builtin.command:
            argv:
              - aws
              - cloudfront
              - update-distribution
              - --id
              - "{{ cloudfront_distribution_id }}"
              - --if-match
              - "{{ cloudfront_disable_etag }}"
              - --distribution-config
              - "file://{{ cloudfront_disable_tmp.path }}"
          changed_when: true
          when:
            - cloudfront_disable_etag is defined
            - cloudfront_disable_tmp.path is defined
