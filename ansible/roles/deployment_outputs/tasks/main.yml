---
- name: Build GitHub outputs
  when: github_deployer_enabled
  block:
    - name: Lookup AWS account id for outputs
      amazon.aws.aws_caller_info:
      register: output_account_lookup
      when:
        - (aws_account_id | default('')) == ''

    - name: Store AWS account id for outputs
      ansible.builtin.set_fact:
        aws_account_id: "{{ output_account_lookup.account }}"
      when:
        - output_account_lookup.account is defined
        - output_account_lookup.account | length > 0

    - name: Store GitHub deployer role ARN
      ansible.builtin.set_fact:
        github_deployer_role_arn: "arn:aws:iam::{{ aws_account_id }}:role/{{ github_deployer_role_name }}"
      when:
        - (github_deployer_role_arn | default('')) == ''
        - aws_account_id is defined
        - aws_account_id | length > 0

    - name: Lookup CloudFront distribution id when missing
      ansible.builtin.command:
        argv:
          - aws
          - cloudfront
          - list-distributions
          - --query
          - "DistributionList.Items[?Comment=='{{ cloudfront_comment }}'].Id | [0]"
          - --output
          - text
      register: cloudfront_id_lookup
      changed_when: false
      when:
        - cloudfront_enabled
        - (cloudfront_distribution_id | default('')) == ''

    - name: Store CloudFront distribution id
      ansible.builtin.set_fact:
        cloudfront_distribution_id: "{{ cloudfront_id_lookup.stdout }}"
      when:
        - cloudfront_enabled
        - (cloudfront_distribution_id | default('')) == ''
        - cloudfront_id_lookup.stdout is defined
        - cloudfront_id_lookup.stdout != "None"

    - name: Build GitHub site base URL
      ansible.builtin.set_fact:
        github_site_base_url: "{{ site_base_url | default('https://' ~ github_deployer_s3_bucket_name) }}"

    - name: Build GitHub repository variables
      ansible.builtin.set_fact:
        github_repo_variables:
          - "AWS_REGION={{ aws_region }}"
          - "DEPLOY_BRANCH={{ github_repo_branch }}"
          - "AWS_ROLE_ARN={{ github_deployer_role_arn | default('') }}"
          - "BUCKET_NAME={{ github_deployer_s3_bucket_name }}"
          - "CF_DISTRIBUTION_ID={{ github_deployer_cloudfront_distribution_id | default(cloudfront_distribution_id | default('')) }}"
          - "SITE_BASE_URL={{ github_site_base_url }}"

    - name: Output GitHub Actions repository variables
      ansible.builtin.debug:
        msg: "{{ ['Repository variables (GitHub Actions):'] + github_repo_variables }}"

    - name: Output GitHub OIDC role ARN
      ansible.builtin.debug:
        msg:
          - "OIDC role ARN (use as a repo variable or secret if your workflow expects it):"
          - "AWS_ROLE_ARN={{ github_deployer_role_arn }}"
      when: github_deployer_role_arn is defined

- name: Build Route 53 outputs
  when: route53_enabled
  block:
    - name: Lookup Route 53 hosted zone details when missing
      amazon.aws.route53_info:
        query: hosted_zone
        hosted_zone_method: details
        hosted_zone_id: "{{ route53_zone_id }}"
      register: route53_name_servers_lookup
      when:
        - route53_zone_id is defined
        - (route53_name_servers | default([]) | length) == 0

    - name: Store Route 53 name servers for outputs
      ansible.builtin.set_fact:
        route53_name_servers: "{{ route53_name_servers_lookup.DelegationSet.NameServers }}"
      when:
        - route53_name_servers_lookup.DelegationSet is defined
        - route53_name_servers_lookup.DelegationSet.NameServers is defined
        - route53_name_servers_lookup.DelegationSet.NameServers | length > 0

    - name: Output Route 53 name servers
      ansible.builtin.debug:
        msg: "{{ ['Route 53 name servers for ' ~ route53_zone_name ~ ':'] + route53_name_servers }}"
      when:
        - route53_name_servers is defined
        - route53_name_servers | length > 0

- name: Output next-step reminder
  ansible.builtin.debug:
    msg:
      - "Next steps: set the GitHub variables and update your domain registrar with the Route 53 name servers."
      - "After ACM validation completes, run: ansible-playbook playbooks/post_validation.yml"
