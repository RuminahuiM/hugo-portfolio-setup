---
- name: Provision Hugo portfolio AWS resources
  hosts: all
  gather_facts: false
  vars:
    s3_state: present
    cloudfront_state: present
    acm_state: present
    route53_state: present
    github_deployer_state: present
    github_oidc_provider_state: present
    iam_state: present
  environment:
    AWS_REGION: "{{ aws_region }}"
    AWS_DEFAULT_REGION: "{{ aws_region }}"
  pre_tasks:
    - name: Reset GitHub deployer state for this run
      ansible.builtin.set_fact:
        github_deployer_state: present
        github_oidc_provider_state: present
    - name: Clear CloudFront identifiers for fresh create
      ansible.builtin.set_fact:
        cloudfront_distribution_id: ""
        cloudfront_domain_name: ""
      when:
        - not keep_cloudfront
  roles:
    - role: s3_static_site
      when: s3_enabled
    - role: route53_hosted_zone
      when: route53_enabled
    - role: acm_certificate
      when: acm_enabled
    - role: cloudfront_distribution
      when: cloudfront_enabled
    - role: github_deployer_role
      when: github_deployer_enabled
    - role: route53_records
      when: route53_enabled
    - role: iam_role
      when: iam_enabled
    - role: deployment_outputs
